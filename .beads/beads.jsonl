{"id":"mcp_agent_mail-8m0","content_hash":"d30618f36611754e70e7f9434cae6d4464a049a3f78758ae0179c9a51ecc2327","title":"Add tests for agent deregistration","description":"## Overview\nComprehensive test coverage for the deregistration feature.\n\n## Parent Issue\nSee gt-4go in gastown for requirements.\n\n## Test Location\nAdd tests to existing test file(s) in tests/ directory, following project conventions.\n\n## Unit Tests\n\n### test_deregister_basic\n- Register agent, deregister, verify deregistered_ts set\n- Verify contact links removed (both directions)\n- Verify file reservations released\n- Verify build slots released\n\n### test_deregister_idempotent\n- Deregister same agent twice -\u003e no error\n- Second call returns already_deregistered=True\n- Cleanup operations are safe to re-run\n\n### test_deregister_nonexistent\n- Deregister unknown agent -\u003e success\n- Returns was_registered=False\n\n### test_deregister_delete_inbox\n- With delete_inbox=True -\u003e message_recipients deleted\n- With delete_inbox=False -\u003e message_recipients preserved\n- Verify count returned matches actual deletions\n\n### test_reactivation\n- Register -\u003e deregister -\u003e register same name\n- Verify deregistered_ts cleared\n- Verify new metadata applied\n- Verify old contact links NOT restored\n\n## Integration Tests\n\n### test_send_to_deregistered\n- Deregister recipient, try to send -\u003e clear error message\n\n### test_send_from_deregistered  \n- Deregister sender, try to send -\u003e clear error message\n\n### test_fetch_inbox_deregistered\n- Deregister agent, try fetch_inbox -\u003e rejected\n\n### test_whois_deregistered\n- Deregister agent, whois -\u003e works, shows deregistered_ts in response\n\n### test_list_contacts_excludes_deregistered\n- Create contact link, deregister one agent\n- list_contacts excludes the deregistered agent\n\n### test_agents_resource_excludes_deregistered\n- Register agents, deregister one\n- resource://agents excludes deregistered\n\n### test_request_contact_deregistered\n- Try to request contact with deregistered agent -\u003e rejected\n\n## Acceptance Criteria\n- [ ] All unit tests pass\n- [ ] All integration tests pass\n- [ ] Edge case coverage\n- [ ] Error messages are clear and actionable","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T14:01:49.619359-08:00","updated_at":"2025-11-24T15:14:58.133055-08:00","source_repo":".","dependencies":[{"issue_id":"mcp_agent_mail-8m0","depends_on_id":"mcp_agent_mail-e69","type":"blocks","created_at":"2025-11-24T14:03:18.570007-08:00","created_by":"daemon"},{"issue_id":"mcp_agent_mail-8m0","depends_on_id":"mcp_agent_mail-crk","type":"blocks","created_at":"2025-11-24T14:03:18.643555-08:00","created_by":"daemon"},{"issue_id":"mcp_agent_mail-8m0","depends_on_id":"mcp_agent_mail-dhm","type":"blocks","created_at":"2025-11-24T14:03:18.72604-08:00","created_by":"daemon"}]}
{"id":"mcp_agent_mail-crk","content_hash":"1011f13028593b8f07178070cf8b543781f92ed6256a9ce9e55b005130aac563","title":"Support agent reactivation on re-registration","description":"## Overview\nWhen registering an agent name that was previously deregistered, clear the deregistered_ts to reactivate.\n\n## Parent Issue\nSee gt-4go in gastown for motivation.\n\n## Implementation\nModify `_get_or_create_agent()` in app.py (around line 1550):\n\n```python\nif agent:\n    if agent.deregistered_ts:\n        agent.deregistered_ts = None  # Reactivate\n    agent.program = program\n    agent.model = model\n    agent.task_description = task_description\n    agent.last_active_ts = datetime.now(timezone.utc)\n    # ... rest unchanged\n```\n\n## Behavior Notes\n- Reactivation does NOT restore old contact links (must re-establish)\n- Reactivation does NOT restore inbox if delete_inbox=True was used during deregistration\n- Agent gets fresh metadata (program, model, task_description)\n- Archive profile.json updated without deregistered_ts field\n\n## Acceptance Criteria\n- [ ] Registering a deregistered name clears deregistered_ts\n- [ ] Agent profile updated in archive without deregistered_ts field\n- [ ] Old contact links remain deleted (not auto-restored)\n- [ ] last_active_ts updated on reactivation","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T14:01:48.253995-08:00","updated_at":"2025-11-24T15:15:01.57359-08:00","source_repo":".","dependencies":[{"issue_id":"mcp_agent_mail-crk","depends_on_id":"mcp_agent_mail-vq4","type":"blocks","created_at":"2025-11-24T14:03:18.42146-08:00","created_by":"daemon"}]}
{"id":"mcp_agent_mail-dhm","content_hash":"395fe6ee83a8169515e31a07eacf5ebd43846bca1d0a58199aa6ebbc50f35dac","title":"Filter deregistered agents from queries","description":"## Overview\nAdd deregistered_ts IS NULL filtering to queries so deregistered agents are invisible.\n\n## Parent Issue\nSee gt-4go in gastown for motivation.\n\n## Changes Required\n\n### 1. New Helper Function\nAdd `_get_agent_including_deregistered(project, name)` for whois lookup.\n\n### 2. Update _get_agent()\nAdd filter: `Agent.deregistered_ts.is_(None)`\n\n### 3. Update send_message validation\n```python\nif sender.deregistered_ts:\n    raise ValueError(f\"Deregistered agent '{sender.name}' cannot send messages\")\nfor recipient, _ in recipients:\n    if recipient.deregistered_ts:\n        raise ValueError(f\"Cannot send to deregistered agent '{recipient.name}'\")\n```\n\n### 4. Update list_contacts tool\nFilter out deregistered agents from contact list results.\n\n### 5. Update request_contact tool  \nReject requests to/from deregistered agents.\n\n### 6. Update fetch_inbox tool\nDeregistered agent cannot fetch their own inbox (they're deregistered).\n\n### 7. Update resource://agents/{project}\nExclude deregistered agents from listing.\n\n## NOT Filtered (per requirements)\n- whois - should work for audit/history lookup (uses new helper)\n\n## Acceptance Criteria\n- [ ] _get_agent() excludes deregistered\n- [ ] _get_agent_including_deregistered() returns all agents\n- [ ] send_message rejects deregistered sender/recipients with clear error\n- [ ] list_contacts excludes deregistered\n- [ ] request_contact rejects deregistered\n- [ ] fetch_inbox rejects deregistered agent\n- [ ] resource://agents excludes deregistered\n- [ ] whois still works on deregistered agents","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T14:01:48.944027-08:00","updated_at":"2025-11-24T15:14:56.764797-08:00","source_repo":".","dependencies":[{"issue_id":"mcp_agent_mail-dhm","depends_on_id":"mcp_agent_mail-vq4","type":"blocks","created_at":"2025-11-24T14:03:18.492639-08:00","created_by":"daemon"}]}
{"id":"mcp_agent_mail-e69","content_hash":"f050319341038e9edd1a4831ec26b9627d172f81c38666703d80dde688c6a7cc","title":"Implement deregister_agent tool","description":"## Overview\nNew MCP tool to soft-delete an agent identity from a project.\n\n## Parent Issue\nSee gt-4go in gastown for motivation and integration requirements.\n\n## Tool Signature\n```python\n@mcp.tool(name=\"deregister_agent\")\nasync def deregister_agent(\n    ctx: Context,\n    project_key: str,\n    agent_name: str,\n    delete_inbox: bool = False,\n) -\u003e dict[str, Any]\n```\n\n## Tool Metadata\n- Cluster: CLUSTER_IDENTITY\n- Capabilities: {\"identity\"}\n- agent_arg: \"agent_name\"\n- project_arg: \"project_key\"\n\n## Cleanup Operations (in order)\n1. Validate agent exists (return was_registered=False if not)\n2. Check if already deregistered (return already_deregistered=True if so)\n3. Set deregistered_ts = NOW() on agent record\n4. DELETE from agent_links where (a_agent_id=? AND a_project_id=?) OR (b_agent_id=? AND b_project_id=?) -- handles cross-project links\n5. UPDATE file_reservations SET released_ts=NOW() WHERE agent_id=? AND released_ts IS NULL\n6. Release build slots: find JSON files in build_slots/*/ matching agent, set expires_ts to now\n7. If delete_inbox: DELETE from message_recipients WHERE agent_id=?\n8. Write updated profile to archive via write_agent_profile()\n\n## Return Value\n```python\n{\n    'agent_name': str,\n    'was_registered': bool,\n    'already_deregistered': bool,\n    'contact_links_removed': int,\n    'file_reservations_released': int,\n    'build_slots_released': int,\n    'inbox_records_deleted': int,\n}\n```\n\n## Idempotency\n- Non-existent agent: was_registered=False, no error\n- Already deregistered: already_deregistered=True, re-run cleanup (safe)","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-24T14:01:47.664311-08:00","updated_at":"2025-11-24T15:14:55.476245-08:00","source_repo":".","dependencies":[{"issue_id":"mcp_agent_mail-e69","depends_on_id":"mcp_agent_mail-vq4","type":"blocks","created_at":"2025-11-24T14:03:18.35315-08:00","created_by":"daemon"}]}
{"id":"mcp_agent_mail-vq4","content_hash":"796433f4ea571cfd2e0066a9646a7739792c2c5f23245dda75e91d948278102d","title":"Add deregistered_ts field to Agent model","description":"## Overview\nAdd soft-delete support for agents via a new timestamp field.\n\n## Parent Issue\nSee gt-4go in gastown for motivation.\n\n## Implementation\n\n### models.py\nAdd to Agent class:\n```python\nderegistered_ts: Optional[datetime] = Field(default=None)\n```\n\n### _agent_to_dict() in app.py\nEnsure deregistered_ts is included in the dict representation for archive serialization.\n\n## Notes\n- Field is nullable - None means agent is active\n- No index needed (rare query pattern)\n- SQLModel will handle schema migration for new installs\n- Existing DBs: SQLite adds nullable column with NULL default (safe)\n\n## Acceptance Criteria\n- [ ] Field added to Agent model in models.py\n- [ ] _agent_to_dict() includes deregistered_ts when set\n- [ ] Database migration works (new installs + existing DBs)\n- [ ] Field appears in agent profile JSON serialization","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-24T14:01:47.048524-08:00","updated_at":"2025-11-24T15:34:44.94414-08:00","closed_at":"2025-11-24T15:34:44.94414-08:00","source_repo":"."}
